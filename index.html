<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Othello</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <header>
    </header>
    <div class="container">
        <div id="board"></div>
        <div id="current-player"></div>
    </div>
</body>

<script type="text/javascript">
    const BOARD_SIZE = 8
    const FIELD_LENGTH = 62 // px
    const BOARD = document.getElementById('board')
    const COLOR_KEY = {
        b: {
            class: 'black-piece',
            text: '黒'
        },
        w: {
            class: 'white-piece',
            text: '黒'
        }
    }

    const genId = (x, y) => `${x}_${y}`
    const getField = (fieldNumber) =>
        document.getElementById(genId(fieldNumber.x, fieldNumber.y))
    const getPiece = (fieldNumber) => getField(fieldNumber)?.children[0]
    const isBlack = (piece) => piece.classList.contains(COLOR_KEY.b.class)
    const isSameColor = (piece, color) => !isBlack(piece) ^ color === 'b'
    const isExistPiece = (fieldNumber) => getField(fieldNumber)?.classList.contains('fill')
    const isAblePut = (targetField) => targetField.classList.contains('able-put')

    let currentColor = 'b'

    function createBoard() {
        for (let x = 0; x < BOARD_SIZE; x++) {
            const col = document.createElement('div')
            col.classList.add('col')
            BOARD.appendChild(col)
            for (let y = 0; y < BOARD_SIZE; y++) {
                const field = document.createElement('div')
                field.id = genId(x, y)
                field.classList.add('field')
                col.appendChild(field)
            }
        }
    }

    function putPiece(fieldNumber, colorKey) {
        // REVIEW: ↓の指摘を踏まえると、ここではgetPiece()で駒の有無判定を行えば良いのでは？
        // そうすると、isExistPiece()は削除できる気がする。
        if (isExistPiece(fieldNumber)) return
        
        const field = getField(fieldNumber)
        const piece = document.createElement('div')
        piece.classList.add(COLOR_KEY[colorKey].class)
        field.appendChild(piece)

        field.classList.add('fill')
        return piece
    }

    function putInitPiece() {
        putPiece({x: 3, y: 3}, 'w')
        putPiece({x: 4, y: 4}, 'w')
        putPiece({x: 3, y: 4}, 'b')
        putPiece({x: 4, y: 3}, 'b')
    }

    function getFieldNumber(clickEvent) {
        const clickX = clickEvent.pageX
        const clickY = clickEvent.pageY

        // ボードの位置を取得
        const clientRect = BOARD.getBoundingClientRect()
        const positionX = clientRect.left + window.pageXOffset
        const positionY = clientRect.top + window.pageYOffset

        // ボード内のクリック位置を計算
        const x = clickX - positionX
        const y = clickY - positionY

        // 何マス目かを計算
        const noX = parseInt(x / FIELD_LENGTH)
        const noY = parseInt(y / FIELD_LENGTH)
        return {x: noX, y: noY}
    }

    function hasTurnablePiece(color /** REVIEW: 何の色かが想像できる変数名に直そう */, getNextFieldNumber) {
        /**
         * REVIEW: getNextFieldNumber() は必ず getPiece(targetFieldNumber) とセットで呼び出す必要がある。
         * なので、getNextFieldNumber()（fieldNumberを取得する）のではなく、
         * getNextPiece()（pieceを取得する）に変更した方が良さそう。
         */
        let targetFieldNumber = getNextFieldNumber()
        // REVIEW: 存在有無をチェックしてからじゃないとtargetPieceは取れないの？
        // 有ったら取る、無かったらundefinedを得る　ではダメか？
        if (!isExistPiece(targetFieldNumber)) {
            return false
        }
        let targetPiece = getPiece(targetFieldNumber)
        if (!targetPiece || isSameColor(targetPiece, color)) {
            return false
        }

        for (targetFieldNumber = getNextFieldNumber();
            // REVIEW: ここも、存在有無をチェックしてからじゃないとtargetPieceは取れないの？
            // 有ったら取る、無かったらundefinedを得る　ではダメか？
            isExistPiece(targetFieldNumber);
            targetFieldNumber = getNextFieldNumber()) {
            targetPiece = getPiece(targetFieldNumber)
            if (!targetPiece) {
                return false
            }
            if (isSameColor(targetPiece, color)) {
                return true
            }
        }
        return false
    }

    function turnPiece(piece){
        piece.classList.toggle('white-piece')
        piece.classList.toggle('black-piece')
    }

    function turnPiecesOnLine(color /** REVIEW: 何の色かが想像できる変数名に直そう */, getNextFieldNumber) {
        let targetFieldNumber = getNextFieldNumber()
        let targetPiece = getPiece(targetFieldNumber)
        while (!isSameColor(targetPiece, color)) {
            turnPiece(targetPiece)
            targetFieldNumber = getNextFieldNumber()
            targetPiece = getPiece(targetFieldNumber)
        }
    }

    function genNextFieldNumberGetter(initFieldNumber, x, y) {
        let fieldNumber = initFieldNumber
        return () => {
            fieldNumber = {x: fieldNumber.x + x, y: fieldNumber.y + y}
            return fieldNumber
        }
    }

    function turnPieces(fieldNumber) {
        for (let x = -1; x <= 1; x++) {
            for (let y = -1; y <= 1; y++) {
                // REVIEW: ぱっと見が分かりづらいから、
                // ここもx=0, y=0の時を除くようになってた方が分かりやすそう。
                let getNextFieldNumber = genNextFieldNumberGetter(fieldNumber, x, y)
                if (hasTurnablePiece(currentColor, getNextFieldNumber)) {
                    getNextFieldNumber = genNextFieldNumberGetter(fieldNumber, x, y)
                    turnPiecesOnLine(currentColor, getNextFieldNumber)
                }
            }
        }
    }

    function changePlayer() {
        currentColor = currentColor === 'b' ? 'w' : 'b'
        document.getElementById('current-player').innerHTML = COLOR_KEY[currentColor].text
    }

    BOARD.onclick = (event) => {
        const fieldNumber = getFieldNumber(event)
        /**
         * REVIEW: ここのタイミングで、本当に置ける場所をクリックしたかどうかを判定する必要がある。
         * コード例）:
         * let piece = undefined
         * if (canPut(hoge, foo)) {
         *     piece = putPiece(fieldNumber, currentColor)
         * }
         */
        const piece = putPiece(fieldNumber, currentColor)
        if (piece) {
            turnPieces(fieldNumber)
            resetAblePut()
            changePlayer()
            addAblePut()
        }
    }

    function addAblePut() {
        /**
         * x=0, y=0の時は無視するので、
         * x,yのループが外側の方が効率的では？
         * コード例）:
         * for (xのループ) {
         *     for (yのループ) {
         *         if (x=0 かつ y=0) continue
         *
         *         for (bxのループ) {
         *             for (byのループ) {
         *                 // 中身の処理
         *             }
         *         }
         *     }
         * }
         */
        for (let bx = 0; bx < BOARD_SIZE; bx++) {
            for (let by = 0; by < BOARD_SIZE; by++) {
                for (let x = -1; x <= 1; x++) {
                    for (let y = -1; y <= 1; y++) {
                        if (!(x === 0 && y === 0)) {
                            let targetFieldNumber = {x: bx, y: by}
                            let getNextFieldNumber = genNextFieldNumberGetter(targetFieldNumber, x, y)
                            if (hasTurnablePiece(currentColor, getNextFieldNumber)) {
                                getField(targetFieldNumber).classList.add('able-put')
                            }
                        }
                    }
                }
            }
        }
    }

    function resetAblePut() {
        Array.from(document.getElementsByClassName('able-put'))
            .forEach(elm => {return elm.classList.remove('able-put')})
    }


    createBoard()
    putInitPiece()



</script>

</html>