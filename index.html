<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Othello</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <header>
    </header>
    <div class="container">
        <div id="board"></div>
    </div>
</body>

<script type="text/javascript">
    const BOARD_SIZE = 8
    const FIELD_LENGTH = 62 // px
    const BOARD = document.getElementById('board')
    const COLOR_KEY = {
        b: {
            class: 'black-piece'
        },
        w: {
            class: 'white-piece'
        }
    }

    const genId = (x, y) => `${x}_${y}`
    const getField = (fieldNumber) =>
        document.getElementById(genId(fieldNumber.x, fieldNumber.y))
    const getPiece = (fieldNumber) => getField(fieldNumber)?.children[0]
    const isBlack = (piece) => piece.classList.contains(COLOR_KEY.b.class)
    const isSameColor = (piece1, piece2) => isBlack(piece1) === isBlack(piece2)
    const isExistPiece = (fieldNumber) => getField(fieldNumber)?.classList.contains('fill')

    let currentColor = 'b'

    function createBoard() {
        for (let x = 0; x < BOARD_SIZE; x++) {
            const col = document.createElement('div')
            col.classList.add('col')
            BOARD.appendChild(col)
            for (let y = 0; y < BOARD_SIZE; y++) {
                const field = document.createElement('div')
                field.id = genId(x, y)
                field.classList.add('field')
                col.appendChild(field)
            }
        }
    }

    function putPiece(fieldNumber, colorKey) {
        const field = getField(fieldNumber)
        if (field.classList.contains('fill')) return

        const piece = document.createElement('div')
        piece.classList.add(COLOR_KEY[colorKey].class)
        field.appendChild(piece)

        field.classList.add('fill')
        return piece
    }

    function putInitPiece() {
        putPiece({x: 3, y: 3}, 'w')
        putPiece({x: 4, y: 4}, 'w')
        putPiece({x: 3, y: 4}, 'b')
        putPiece({x: 4, y: 3}, 'b')
    }

    function getFieldNumber(clickEvent) {
        const clickX = clickEvent.pageX
        const clickY = clickEvent.pageY

        // ボードの位置を取得
        const clientRect = BOARD.getBoundingClientRect()
        const positionX = clientRect.left + window.pageXOffset
        const positionY = clientRect.top + window.pageYOffset

        // ボード内のクリック位置を計算
        const x = clickX - positionX
        const y = clickY - positionY

        // 何マス目かを計算
        const noX = parseInt(x / FIELD_LENGTH)
        const noY = parseInt(y / FIELD_LENGTH)
        return {x: noX, y: noY}
    }

    function hasSameColorPiece(fieldNumber, getNextFieldNumber) {
        let currentPiece = getPiece(fieldNumber)
        for (let targetFieldNumber = getNextFieldNumber(fieldNumber);
            isExistPiece(targetFieldNumber);
            targetFieldNumber = getNextFieldNumber(targetFieldNumber)) {
            const targetPiece = getPiece(targetFieldNumber)
            if (!targetPiece) {
                return false
            }
            if (isSameColor(targetPiece, currentPiece)) {
                return true
            }
        }
        return false
    }

    function turnPiece(piece){
        piece.classList.toggle('white-piece')
        piece.classList.toggle('black-piece')
    }

    function turnPiecesOnLine(fieldNumber, getNextFieldNumber) {
        let currentPiece = getPiece(fieldNumber)
        let targetFieldNumber = getNextFieldNumber(fieldNumber)
        let targetPiece = getPiece(targetFieldNumber)
        while (!isSameColor(targetPiece, currentPiece)) {
            turnPiece(targetPiece)
            targetFieldNumber = getNextFieldNumber(targetFieldNumber)
            targetPiece = getPiece(targetFieldNumber)
        }
    }

    function genNextFieldNumberGetter(x, y) {
        return (fieldNumber) => {return {x: fieldNumber.x + x, y: fieldNumber.y + y}}
    }

    function turnPieces(fieldNumber) {
        for (let x = -1; x <= 1; x++) {
            for (let y = -1; y <= 1; y++) {
                let getNextFieldNumber = genNextFieldNumberGetter(x, y)
                if (hasSameColorPiece(fieldNumber, getNextFieldNumber)) {
                    turnPiecesOnLine(fieldNumber, getNextFieldNumber)
                }
            }
        }
    }

    BOARD.onclick = (event) => {
        const fieldNumber = getFieldNumber(event)
        const piece = putPiece(fieldNumber, currentColor)
        if (piece) {
            currentColor = currentColor === 'b' ? 'w' : 'b'
            turnPieces(fieldNumber)
        }
    }


    createBoard()
    putInitPiece()



</script>

</html>